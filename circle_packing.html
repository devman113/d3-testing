<!DOCTYPE html>
<meta charset="utf-8">
<style>
circle {
  fill: rgb(31, 119, 180);
  fill-opacity: .25;
  stroke: rgb(31, 119, 180);
  stroke-width: 1px;
}

.leaf circle {
  fill: #ff7f0e;
  fill-opacity: 1;
}

text {
  font: 10px sans-serif;
  text-anchor: middle;
}
</style>
<body>
  <svg width="960" height="960"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
  var svg = d3.select("svg"),
    diameter = +svg.attr("width"),
    g = svg.append("g").attr("transform", "translate(2,2)"),
    format = d3.format(",d");

  var pack = d3.pack()
      .size([diameter - 4, diameter - 4]);

  var hierarchyData;
  d3.json("http://localhost:8000/mockData.json", function(error, dataSet) {
    var propertyKeys = [];
    if (dataSet.length > 0) {
      propertyKeys = Object.keys(dataSet[0]);
      var select = d3.select('body')
        .append('select')
          .attr('class','propertyList')
          .on('change',onchange)

      var options = select
        .selectAll('option')
        .data(propertyKeys).enter()
        .append('option')
          .text(function (d) { return d; });
          
      onchange();
      
      function onchange() {
        var selectedColumn = d3.select('.propertyList').property('value');
        
        var columnList = orderChange([].concat(propertyKeys), selectedColumn);
        hierarchyData = generateHierarchicalDataSet(dataSet, columnList);

        console.log(hierarchyData);

        root = d3.hierarchy(hierarchyData)
          .sum(function(d) { return d.size; })
          .sort(function(a, b) { return b.value - a.value; });

        // g.selectAll(".leaf").remove();
        // g.selectAll("title").remove();
        g.selectAll("*").remove();

        var node = g.selectAll(".node")
          .data(pack(root).descendants())
          .enter().append("g")
            .attr("class", function(d) { return d.children ? "node" : "leaf node"; })
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

        node.append("title")
            .text(function(d) { return d.data.name + "\n" + format(d.value); });

        node.append("circle")
            .attr("r", function(d) { return d.r; });

        node.filter(function(d) { return !d.children; }).append("text")
            .attr("dy", "0.3em")
            .text(function(d) { return d.data.name.substring(0, d.r / 3); });


      };

    }
  });

  function orderChange(originColumnList, selectedColumn) {
    const delIndex = originColumnList.indexOf(selectedColumn);
    originColumnList.splice(delIndex, 1);
    originColumnList.splice(originColumnList.length, 0, selectedColumn);
    console.log(originColumnList);
    return originColumnList;
  }
  
  function findWithAttr(array, attr, value) {
    for(var i = 0; i < array.length; i += 1) {
        if(array[i][attr] === value) {
            return i;
        }
    }
    return -1;
  }
  function generateHierarchicalDataSet(dataSet, columnList) {
    var hierarchyData = {
      name: `Dataset by ${columnList[columnList.length - 1]}`,
      children: [
      ]
    };
    for (var i = 0; i < dataSet.length; i++) {
      var dataElement = dataSet[i];
      var currentObj = hierarchyData;
      for (var j = 0; j < columnList.length; j++) {

          var eachVal = dataElement[columnList[j]];
          var newName = `${eachVal} (${columnList[j]})`;

          var childObj = j < columnList.length - 1 ? {
            name: newName,
            children: []
          } : {
            name: newName,
            size: 1
          };

          var nextIndex = -1;

          if (!currentObj.children)
            currentObj.children = [childObj];

          var foundIndex = findWithAttr( currentObj.children, 'name', `${eachVal} (${columnList[j]})`);

          if (foundIndex > -1) nextIndex = foundIndex;
          else {
            nextIndex = currentObj.children.length;
            currentObj.children.push(childObj);
          }

          currentObj = currentObj.children[nextIndex];
        
      }      
    }
    return hierarchyData;
  }

</script>